{% extends "base.html" %}

{% block title %}Server Status - PiBot{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h3><i class="fas fa-server"></i> Server Status</h3>
            <button class="btn btn-primary" onclick="refreshStatus()">
                <i class="fas fa-sync-alt" id="refreshIcon"></i> Refresh
            </button>
        </div>
        <p class="text-muted">
            <i class="fas fa-shield-alt"></i> Administrator access required - Real-time server monitoring and system information
        </p>
    </div>
</div>

<!-- Loading indicator -->
<div id="loadingIndicator" class="text-center">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading server status...</p>
</div>

<!-- Status content (hidden initially) -->
<div id="statusContent" style="display: none;">
    <!-- Server Information -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-globe"></i> Server Network Information</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-home fa-2x text-success mb-2"></i>
                                <h6>Local Access</h6>
                                <p class="mb-1"><code id="localUrl">http://localhost:8080</code></p>
                                <small class="text-muted">Same device</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-network-wired fa-2x text-info mb-2"></i>
                                <h6>Network Access</h6>
                                <p class="mb-1"><code id="networkUrl">http://192.168.x.x:8080</code></p>
                                <small class="text-muted">Local network devices</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-globe fa-2x text-warning mb-2"></i>
                                <h6>External Access</h6>
                                <p class="mb-1"><code id="externalUrl">http://x.x.x.x:8080</code></p>
                                <small class="text-muted">Internet access</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <i class="fas fa-wifi fa-2x text-secondary mb-2"></i>
                                <h6>WiFi Network</h6>
                                <p class="mb-1"><span id="wifiSSID" class="badge bg-secondary">Unknown</span></p>
                                <small class="text-muted">Current network</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Cards Row -->
    <div class="row mb-4">
        <!-- Ollama Status -->
        <div class="col-lg-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h6 class="mb-0"><i class="fas fa-robot"></i> Ollama Status</h6>
                    <span id="ollamaStatusBadge" class="badge bg-light text-dark">Checking...</span>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <i id="ollamaIcon" class="fas fa-question-circle fa-3x text-muted"></i>
                    </div>
                    <div class="row text-center">
                        <div class="col-6">
                            <h4 id="modelCount" class="mb-1">-</h4>
                            <small class="text-muted">Models Available</small>
                        </div>
                        <div class="col-6">
                            <h4 id="ollamaPort" class="mb-1">11434</h4>
                            <small class="text-muted">Port</small>
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>Available Models:</h6>
                        <div id="modelsList" class="d-flex flex-wrap gap-1">
                            <span class="badge bg-secondary">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Resources -->
        <div class="col-lg-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-microchip"></i> System Resources</h6>
                </div>
                <div class="card-body">
                    <!-- CPU Usage -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>CPU Usage</small>
                            <small id="cpuPercent">0%</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="cpuProgress" class="progress-bar bg-primary" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Memory Usage -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Memory Usage</small>
                            <small id="memoryPercent">0%</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="memoryProgress" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="memoryDetails">0 GB / 0 GB</small>
                    </div>

                    <!-- Disk Usage -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small>Disk Usage</small>
                            <small id="diskPercent">0%</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="diskProgress" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="diskDetails">0 GB / 0 GB</small>
                    </div>

                    <!-- System Uptime -->
                    <div class="text-center">
                        <h6>System Uptime</h6>
                        <p id="systemUptime" class="mb-0">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Statistics -->
        <div class="col-lg-4 mb-3">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-database"></i> Database Statistics</h6>
                </div>
                <div class="card-body">
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <h4 id="totalUsers" class="mb-1 text-primary">-</h4>
                            <small class="text-muted">Total Users</small>
                        </div>
                        <div class="col-6">
                            <h4 id="totalSessions" class="mb-1 text-success">-</h4>
                            <small class="text-muted">Chat Sessions</small>
                        </div>
                    </div>
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <h4 id="totalMessages" class="mb-1 text-info">-</h4>
                            <small class="text-muted">Messages</small>
                        </div>
                        <div class="col-6">
                            <h4 id="totalRatings" class="mb-1 text-warning">-</h4>
                            <small class="text-muted">Ratings</small>
                        </div>
                    </div>
                    <hr>
                    <h6>Recent Activity (24h)</h6>
                    <div class="row text-center">
                        <div class="col-6">
                            <span id="recentSessions" class="badge bg-success">-</span>
                            <small class="text-muted d-block">New Sessions</small>
                        </div>
                        <div class="col-6">
                            <span id="recentMessages" class="badge bg-info">-</span>
                            <small class="text-muted d-block">New Messages</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Last Updated -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center">
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> Last updated: <span id="lastUpdated">-</span>
                        | Auto-refresh every 30 seconds
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let statusData = null;
    let refreshInterval = null;

    function formatBytes(bytes) {
        return (bytes / (1024 ** 3)).toFixed(2);
    }

    function formatUptime(days, hours, minutes) {
        if (days > 0) {
            return `${days}d ${hours}h ${minutes}m`;
        } else if (hours > 0) {
            return `${hours}h ${minutes}m`;
        } else {
            return `${minutes}m`;
        }
    }

    function updateProgressBar(elementId, percentage) {
        const element = document.getElementById(elementId);
        element.style.width = percentage + '%';
        
        // Color coding for progress bars
        element.className = 'progress-bar';
        if (percentage < 50) {
            element.classList.add('bg-success');
        } else if (percentage < 80) {
            element.classList.add('bg-warning');
        } else {
            element.classList.add('bg-danger');
        }
    }

    function updateServerInfo(data) {
        // Network information
        const localUrl = `http://localhost:${data.server.port}`;
        const networkUrl = `http://${data.server.local_ip}:${data.server.port}`;
        const externalUrl = `http://${data.server.external_ip}:${data.server.port}`;
        
        document.getElementById('localUrl').textContent = localUrl;
        document.getElementById('networkUrl').textContent = networkUrl;
        document.getElementById('externalUrl').textContent = externalUrl;
        document.getElementById('wifiSSID').textContent = data.server.wifi_ssid;
    }

    function updateOllamaStatus(data) {
        const statusBadge = document.getElementById('ollamaStatusBadge');
        const icon = document.getElementById('ollamaIcon');
        const modelCount = document.getElementById('modelCount');
        const modelsList = document.getElementById('modelsList');

        if (data.status === 'running') {
            statusBadge.textContent = 'Running';
            statusBadge.className = 'badge bg-success';
            icon.className = 'fas fa-check-circle fa-3x text-success';
            modelCount.textContent = data.model_count;
            
            // Update models list
            if (data.models.length > 0) {
                modelsList.innerHTML = data.models.map(model => 
                    `<span class="badge bg-primary">${model}</span>`
                ).join(' ');
            } else {
                modelsList.innerHTML = '<span class="badge bg-secondary">No models found</span>';
            }
        } else if (data.status === 'offline') {
            statusBadge.textContent = 'Offline';
            statusBadge.className = 'badge bg-danger';
            icon.className = 'fas fa-times-circle fa-3x text-danger';
            modelCount.textContent = '0';
            modelsList.innerHTML = '<span class="badge bg-danger">Ollama server offline</span>';
        } else {
            statusBadge.textContent = 'Error';
            statusBadge.className = 'badge bg-warning';
            icon.className = 'fas fa-exclamation-triangle fa-3x text-warning';
            modelCount.textContent = '0';
            modelsList.innerHTML = '<span class="badge bg-warning">Connection error</span>';
        }
    }

    function updateSystemInfo(data) {
        if (data.error) {
            console.error('System info error:', data.error);
            return;
        }

        // CPU
        document.getElementById('cpuPercent').textContent = data.cpu_percent.toFixed(1) + '%';
        updateProgressBar('cpuProgress', data.cpu_percent);

        // Memory
        document.getElementById('memoryPercent').textContent = data.memory_percent.toFixed(1) + '%';
        document.getElementById('memoryDetails').textContent = 
            `${data.memory_used_gb} GB / ${data.memory_total_gb} GB`;
        updateProgressBar('memoryProgress', data.memory_percent);

        // Disk
        document.getElementById('diskPercent').textContent = data.disk_percent.toFixed(1) + '%';
        document.getElementById('diskDetails').textContent = 
            `${data.disk_used_gb} GB / ${data.disk_total_gb} GB`;
        updateProgressBar('diskProgress', data.disk_percent);

        // Uptime
        document.getElementById('systemUptime').textContent = 
            formatUptime(data.uptime_days, data.uptime_hours, data.uptime_minutes);
    }

    function updateDatabaseStats(data) {
        if (data.error) {
            console.error('Database stats error:', data.error);
            return;
        }

        document.getElementById('totalUsers').textContent = data.total_users;
        document.getElementById('totalSessions').textContent = data.total_sessions;
        document.getElementById('totalMessages').textContent = data.total_messages;
        document.getElementById('totalRatings').textContent = data.total_ratings;
        document.getElementById('recentSessions').textContent = data.recent_sessions_24h;
        document.getElementById('recentMessages').textContent = data.recent_messages_24h;
    }

    function updateLastUpdatedTime() {
        const now = new Date();
        document.getElementById('lastUpdated').textContent = now.toLocaleString();
    }

    function refreshStatus() {
        const refreshIcon = document.getElementById('refreshIcon');
        refreshIcon.classList.add('fa-spin');

        fetch('/api/status', {
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            statusData = data;
            
            // Update all sections
            updateServerInfo(data);
            updateOllamaStatus(data.ollama);
            updateSystemInfo(data.system);
            updateDatabaseStats(data.database);
            updateLastUpdatedTime();

            // Show content and hide loading
            document.getElementById('loadingIndicator').style.display = 'none';
            document.getElementById('statusContent').style.display = 'block';
        })
        .catch(error => {
            console.error('Error fetching status:', error);
            alert('Error fetching server status: ' + error.message);
        })
        .finally(() => {
            refreshIcon.classList.remove('fa-spin');
        });
    }

    // Initial load
    document.addEventListener('DOMContentLoaded', function() {
        refreshStatus();
        
        // Set up auto-refresh every 30 seconds
        refreshInterval = setInterval(refreshStatus, 30000);
    });

    // Clean up interval when leaving page
    window.addEventListener('beforeunload', function() {
        if (refreshInterval) {
            clearInterval(refreshInterval);
        }
    });
</script>
{% endblock %}
