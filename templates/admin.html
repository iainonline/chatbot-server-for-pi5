{% extends "base.html" %}

{% block title %}Admin Dashboard - PiBot{% endblock %}

{% block content %}
<div class="row">
    <div class="col-8">
        <h2><i class="fas fa-cog"></i> Admin Dashboard</h2>
    </div>
    <div class="col-4 text-end">
        <a href="{{ url_for('change_password') }}" class="btn btn-outline-secondary me-2">
            <i class="fas fa-key"></i> Change Password
        </a>
        <a href="{{ url_for('chat') }}" class="btn btn-primary">
            <i class="fas fa-comments"></i> Go to Chat
        </a>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ total_users }}</h4>
                        <p class="mb-0">Total Users</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ total_sessions }}</h4>
                        <p class="mb-0">Chat Sessions</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-comments fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ total_messages }}</h4>
                        <p class="mb-0">Total Messages</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-message fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ model_stats|length }}</h4>
                        <p class="mb-0">Active Models</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-brain fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model Management & Parameters -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-robot"></i> Model Selection & Management</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="adminModelSelect" class="form-label">Select Active Model:</label>
                    <select class="form-select" id="adminModelSelect" onchange="saveDefaultModel()">
                        <!-- Models will be loaded via JavaScript -->
                    </select>
                    <small class="text-muted">This model will be used for all new chat sessions</small>
                </div>
                <div class="mb-3">
                    <button class="btn btn-primary" onclick="refreshModels()">
                        <i class="fas fa-sync"></i> Refresh Models
                    </button>
                    <button class="btn btn-success" onclick="showDownloadModal()">
                        <i class="fas fa-download"></i> Download More Models
                    </button>
                </div>
                <div id="modelStatus" class="mt-2"></div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-sliders-h"></i> Default Model Parameters</h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <label for="adminTemperatureSlider" class="form-label">
                        Temperature: <span id="adminTemperatureValue">0.7</span>
                    </label>
                    <input type="range" class="form-range" id="adminTemperatureSlider" 
                           min="0.1" max="2.0" step="0.1" value="0.7">
                    <small class="text-muted">Controls creativity (0.1=focused, 2.0=creative)</small>
                </div>
                
                <div class="mb-2">
                    <label for="adminMaxTokensSlider" class="form-label">
                        Max Response Length: <span id="adminMaxTokensValue">2048</span>
                    </label>
                    <input type="range" class="form-range" id="adminMaxTokensSlider" 
                           min="100" max="4096" step="100" value="2048">
                    <small class="text-muted">Maximum length of responses</small>
                </div>
                
                <div class="mb-2">
                    <label for="adminTopPSlider" class="form-label">
                        Top-P: <span id="adminTopPValue">0.9</span>
                    </label>
                    <input type="range" class="form-range" id="adminTopPSlider" 
                           min="0.1" max="1.0" step="0.1" value="0.9">
                    <small class="text-muted">Nucleus sampling threshold</small>
                </div>
                
                <div class="mb-2">
                    <label for="adminTopKSlider" class="form-label">
                        Top-K: <span id="adminTopKValue">40</span>
                    </label>
                    <input type="range" class="form-range" id="adminTopKSlider" 
                           min="1" max="100" step="1" value="40">
                    <small class="text-muted">Number of top choices to consider</small>
                </div>
                
                <div class="mb-3">
                    <label for="adminRepeatPenaltySlider" class="form-label">
                        Repeat Penalty: <span id="adminRepeatPenaltyValue">1.1</span>
                    </label>
                    <input type="range" class="form-range" id="adminRepeatPenaltySlider" 
                           min="0.5" max="2.0" step="0.1" value="1.1">
                    <small class="text-muted">Penalty for repetition (1.0=none, 2.0=high)</small>
                </div>
                
                <button class="btn btn-primary" onclick="saveDefaultParameters()">
                    <i class="fas fa-save"></i> Save as Defaults
                </button>
            </div>
        </div>
    </div>
</div>

<!-- System Configuration -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-robot"></i> System Configuration</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="systemPrompt" class="form-label">
                        <strong>System Prompt</strong>
                        <small class="text-muted">- Defines how the AI should behave in all conversations</small>
                    </label>
                    <textarea class="form-control" id="systemPrompt" rows="4" 
                              placeholder="e.g., You are a wise and helpful assistant. Behave like a knowledgeable teacher, providing clear and insightful responses...">{{ system_prompt }}</textarea>
                    <div class="form-text">
                        This prompt will be prepended to all user conversations. Use it to set the AI's personality, tone, and behavior guidelines.
                        <br><strong>Example:</strong> "A human is going to communicate with you, behave like a chatbot and give informative and meaningful responses, like a buddha perhaps"
                    </div>
                </div>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" onclick="updateSystemPrompt()">
                        <i class="fas fa-save"></i> Save System Prompt
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetSystemPrompt()">
                        <i class="fas fa-undo"></i> Clear
                    </button>
                </div>
                <div id="systemPromptStatus" class="mt-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Model Performance -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Model Usage & Ratings</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-dark">
                        <thead>
                            <tr style="color: var(--text-primary);">
                                <th style="color: var(--text-primary);">Model Name</th>
                                <th style="color: var(--text-primary);">Usage Count</th>
                                <th style="color: var(--text-primary);">Average Rating</th>
                                <th style="color: var(--text-primary);">Rating Display</th>
                            </tr>
                        </thead>
                        <tbody style="color: var(--text-primary);">
                            {% for stat in model_stats %}
                            <tr style="color: var(--text-primary);">
                                <td><span class="badge bg-secondary">{{ stat.model_name }}</span></td>
                                <td style="color: var(--text-primary);">{{ stat.usage_count }}</td>
                                <td style="color: var(--text-primary);">
                                    {% if stat.avg_rating %}
                                        {{ "%.2f"|format(stat.avg_rating) }}/5
                                    {% else %}
                                        No ratings yet
                                    {% endif %}
                                </td>
                                <td style="color: var(--text-primary);">
                                    {% if stat.avg_rating %}
                                        <div class="rating-stars">
                                            {% for i in range(1, 6) %}
                                                {% if i <= stat.avg_rating %}
                                                    <i class="fas fa-star"></i>
                                                {% else %}
                                                    <i class="far fa-star"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    {% else %}
                                        <span class="text-muted">No ratings</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> Recent Chat Sessions</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-dark">
                        <thead>
                            <tr style="color: var(--text-primary);">
                                <th style="color: var(--text-primary);">User</th>
                                <th style="color: var(--text-primary);">Model</th>
                                <th style="color: var(--text-primary);">Session Title</th>
                                <th style="color: var(--text-primary);">Created</th>
                                <th style="color: var(--text-primary);">Last Updated</th>
                                <th style="color: var(--text-primary);">Messages</th>
                            </tr>
                        </thead>
                        <tbody style="color: var(--text-primary);">
                            {% for session in recent_sessions %}
                            <tr style="color: var(--text-primary);">
                                <td style="color: var(--text-primary);">{{ session.user.username }}</td>
                                <td><span class="badge bg-info">{{ session.model_name }}</span></td>
                                <td style="color: var(--text-primary);">{{ session.title }}</td>
                                <td style="color: var(--text-primary);">{{ session.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td style="color: var(--text-primary);">{{ session.updated_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <span class="badge bg-secondary">{{ session.messages|length }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- User Feedback -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-comment-dots"></i> User Feedback</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-dark">
                        <thead>
                            <tr style="color: var(--text-primary);">
                                <th style="color: var(--text-primary);">User</th>
                                <th style="color: var(--text-primary);">Type</th>
                                <th style="color: var(--text-primary);">Title</th>
                                <th style="color: var(--text-primary);">Priority</th>
                                <th style="color: var(--text-primary);">Status</th>
                                <th style="color: var(--text-primary);">Created</th>
                                <th style="color: var(--text-primary);">Actions</th>
                            </tr>
                        </thead>
                        <tbody style="color: var(--text-primary);">
                            {% for feedback in user_feedback %}
                            <tr style="color: var(--text-primary);">
                                <td style="color: var(--text-primary);">{{ feedback.user.username }}</td>
                                <td>
                                    <span class="badge 
                                        {% if feedback.feedback_type == 'bug' %}bg-danger
                                        {% elif feedback.feedback_type == 'feature' %}bg-success
                                        {% elif feedback.feedback_type == 'improvement' %}bg-warning
                                        {% else %}bg-info{% endif %}">
                                        {{ feedback.feedback_type.title() }}
                                    </span>
                                </td>
                                <td style="color: var(--text-primary);">
                                    <div class="feedback-title" style="cursor: pointer;" 
                                         title="{{ feedback.description }}" 
                                         onclick="showFeedbackDetails('{{ feedback.id }}', '{{ feedback.title }}', '{{ feedback.description }}')">
                                        {{ feedback.title[:50] }}{% if feedback.title|length > 50 %}...{% endif %}
                                    </div>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if feedback.priority == 'high' %}bg-danger
                                        {% elif feedback.priority == 'medium' %}bg-warning
                                        {% else %}bg-secondary{% endif %}">
                                        {{ feedback.priority.title() }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge 
                                        {% if feedback.status == 'resolved' %}bg-success
                                        {% elif feedback.status == 'in_progress' %}bg-primary
                                        {% else %}bg-secondary{% endif %}">
                                        {{ feedback.status.replace('_', ' ').title() }}
                                    </span>
                                </td>
                                <td style="color: var(--text-primary);">{{ feedback.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="showFeedbackDetails('{{ feedback.id }}', '{{ feedback.title }}', '{{ feedback.description }}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center text-muted">No feedback submitted yet</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Information -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-server"></i> System Information</h5>
            </div>
            <div class="card-body">
                <p><strong>Platform:</strong> Raspberry Pi 5</p>
                <p><strong>Server:</strong> Gunicorn on port 8080</p>
                <p><strong>LLM Backend:</strong> Ollama</p>
                <p><strong>Database:</strong> SQLite</p>
                <div class="mt-3">
                    <button class="btn btn-outline-primary btn-sm" onclick="checkOllamaStatus()">
                        <i class="fas fa-check-circle"></i> Check Ollama Status
                    </button>
                    <span id="ollamaStatus" class="ms-2"></span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-download"></i> Data Export</h5>
            </div>
            <div class="card-body">
                <p>Export chat data for analysis or backup purposes.</p>
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-success" onclick="exportChatData()">
                        <i class="fas fa-download"></i> Export All Chat Data
                    </button>
                    <button class="btn btn-outline-info" onclick="exportUserStats()">
                        <i class="fas fa-chart-line"></i> Export User Statistics
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model Download Modal -->
<div class="modal fade" id="downloadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Download New Model</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="modelNameInput" class="form-label">Model Name:</label>
                    <input type="text" class="form-control" id="modelNameInput" 
                           placeholder="e.g., llama2, mistral, phi, codellama">
                </div>
                <div class="mb-3">
                    <h6>Popular Models:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setModelName('llama2')">llama2</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setModelName('mistral')">mistral</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setModelName('phi')">phi</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setModelName('codellama')">codellama</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setModelName('gemma')">gemma</button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="setModelName('llama2:13b')">llama2:13b</button>
                    </div>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Note:</strong> Model downloads can take several minutes to complete. Larger models (13b, 70b) require more time and storage space.
                </div>
                
                <!-- Download Progress Section -->
                <div id="downloadProgressSection" style="display: none;">
                    <hr>
                    <h6>Download Progress:</h6>
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span id="downloadStatus">Preparing download...</span>
                            <span id="downloadPercentage">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" id="downloadProgressBar" role="progressbar" 
                                 style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                    <div id="downloadDetails" class="small text-muted"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="downloadModel()">
                    <i class="fas fa-download"></i> Download Model
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function checkOllamaStatus() {
        const statusElement = document.getElementById('ollamaStatus');
        statusElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
        
        fetch('/api/ollama/status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'online') {
                    statusElement.innerHTML = '<span class="badge bg-success">Online</span>';
                } else {
                    statusElement.innerHTML = '<span class="badge bg-danger">Offline</span>';
                }
            })
            .catch(error => {
                statusElement.innerHTML = '<span class="badge bg-danger">Error</span>';
            });
    }
    
    function exportChatData() {
        window.location.href = '/api/export/chat-data';
    }
    
    function exportUserStats() {
        window.location.href = '/api/export/user-stats';
    }
    
    function updateSystemPrompt() {
        const prompt = document.getElementById('systemPrompt').value;
        const statusDiv = document.getElementById('systemPromptStatus');
        
        // Show loading state
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin"></i> Updating system prompt...</div>';
        
        fetch('/admin/system-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                system_prompt: prompt
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                statusDiv.innerHTML = '<div class="alert alert-success alert-dismissible fade show"><i class="fas fa-check"></i> ' + data.message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
            } else {
                statusDiv.innerHTML = '<div class="alert alert-danger alert-dismissible fade show"><i class="fas fa-exclamation-triangle"></i> Error: ' + (data.error || 'Unknown error') + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
            }
        })
        .catch(error => {
            statusDiv.innerHTML = '<div class="alert alert-danger alert-dismissible fade show"><i class="fas fa-exclamation-triangle"></i> Network error: ' + error.message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
        });
    }
    
    function resetSystemPrompt() {
        if (confirm('Are you sure you want to clear the system prompt? This will remove all custom behavior instructions.')) {
            document.getElementById('systemPrompt').value = '';
            updateSystemPrompt();
        }
    }
    
    // Admin Parameter Management
    function loadAvailableModels() {
        console.log('Loading available models...');
        
        // Directly get available models without depending on default-parameters API
        fetch('/api/models')
            .then(response => {
                console.log('Models API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Models API response data:', data);
                if (data.status === 'success') {
                    const select = document.getElementById('adminModelSelect');
                    select.innerHTML = '';
                    
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        select.appendChild(option);
                    });
                    
                    console.log('Models loaded successfully, total:', data.models.length);
                    
                    // Load and select the current default model
                    loadCurrentDefaultModel();
                } else {
                    console.error('Models API returned error:', data.message);
                }
            })
            .catch(error => {
                console.error('Error loading models:', error);
                // Fallback: add some basic models
                const select = document.getElementById('adminModelSelect');
                select.innerHTML = '';
                const fallbackModels = ['tinyllama:latest', 'phi:latest'];
                fallbackModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model;
                    option.textContent = model;
                    select.appendChild(option);
                });
                console.log('Added fallback models');
            });
    }
    
    function loadCurrentDefaultModel() {
        console.log('Loading current default model...');
        fetch('/api/current-default-model')
            .then(response => {
                console.log('Default model API response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Default model API response data:', data);
                if (data.status === 'success' && data.model) {
                    const select = document.getElementById('adminModelSelect');
                    select.value = data.model;
                    console.log('Default model set to:', data.model);
                } else {
                    console.error('Default model API returned error:', data.message);
                }
            })
            .catch(error => {
                console.error('Error loading current default model:', error);
                // Try to select first available option as fallback
                const select = document.getElementById('adminModelSelect');
                if (select.options.length > 0) {
                    select.selectedIndex = 0;
                    console.log('Selected first available model as fallback');
                }
            });
    }
    
    function refreshModels() {
        document.getElementById('modelStatus').innerHTML = '<div class="text-info">Refreshing models...</div>';
        loadAvailableModels();
        setTimeout(() => {
            document.getElementById('modelStatus').innerHTML = '<div class="text-success">Models refreshed successfully!</div>';
            setTimeout(() => {
                document.getElementById('modelStatus').innerHTML = '';
            }, 3000);
        }, 1000);
    }
    
    function saveDefaultModel() {
        const modelSelect = document.getElementById('adminModelSelect');
        const selectedModel = modelSelect.value;
        
        if (!selectedModel) return;
        
        // Show saving feedback
        const statusDiv = document.getElementById('modelStatus');
        statusDiv.innerHTML = '<div class="text-info"><i class="fas fa-spinner fa-spin"></i> Saving default model...</div>';
        
        fetch('/admin/save-default-model', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ model_name: selectedModel })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                statusDiv.innerHTML = `<div class="text-success"><i class="fas fa-check"></i> ${data.message}</div>`;
            } else {
                statusDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error: ${data.message}</div>`;
            }
            
            // Clear status after 3 seconds
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        })
        .catch(error => {
            console.error('Error saving default model:', error);
            statusDiv.innerHTML = '<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error saving default model</div>';
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        });
    }
    
    function showDownloadModal() {
        // Show the Bootstrap modal
        const modal = new bootstrap.Modal(document.getElementById('downloadModal'));
        modal.show();
    }
    
    function setModelName(modelName) {
        document.getElementById('modelNameInput').value = modelName;
    }
    
    function downloadModel() {
        const modelName = document.getElementById('modelNameInput').value.trim();
        
        console.log('Download model called with:', modelName);
        
        if (!modelName) {
            alert('Please enter a model name');
            return;
        }
        
        // Show progress section
        document.getElementById('downloadProgressSection').style.display = 'block';
        resetProgressDisplay();
        
        // Update button state
        const downloadBtn = document.querySelector('#downloadModal .btn-primary');
        const originalText = downloadBtn.innerHTML;
        downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';
        downloadBtn.disabled = true;
        
        console.log('Sending download request to server...');
        
        fetch('/api/download-model', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ model_name: modelName })
        })
        .then(response => {
            console.log('Download response received:', response);
            return response.json();
        })
        .then(data => {
            console.log('Download response data:', data);
            if (data.status === 'success') {
                updateDownloadStatus('Download started successfully!', 0);
                // Keep button disabled during download
                downloadBtn.innerHTML = '<i class="fas fa-download"></i> Downloading...';
            } else {
                alert('Error: ' + data.message);
                resetDownloadButton(downloadBtn, originalText);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error starting download: ' + error.message);
            resetDownloadButton(downloadBtn, originalText);
        });
    }
    
    function resetProgressDisplay() {
        document.getElementById('downloadStatus').textContent = 'Preparing download...';
        document.getElementById('downloadPercentage').textContent = '0%';
        document.getElementById('downloadProgressBar').style.width = '0%';
        document.getElementById('downloadProgressBar').setAttribute('aria-valuenow', '0');
        document.getElementById('downloadDetails').textContent = '';
    }
    
    function updateDownloadStatus(message, progress, details = '') {
        console.log('Updating download status:', message, progress, details);
        
        const statusElement = document.getElementById('downloadStatus');
        const percentageElement = document.getElementById('downloadPercentage');
        const progressBar = document.getElementById('downloadProgressBar');
        const detailsElement = document.getElementById('downloadDetails');
        
        if (statusElement) {
            statusElement.textContent = message;
        }
        if (percentageElement) {
            percentageElement.textContent = progress + '%';
        }
        if (progressBar) {
            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
        }
        if (details && detailsElement) {
            detailsElement.textContent = details;
        }
    }
    
    function resetDownloadButton(btn, originalText) {
        btn.innerHTML = originalText;
        btn.disabled = false;
        document.getElementById('downloadProgressSection').style.display = 'none';
    }

    function saveDefaultParameters() {
        const parameters = {
            temperature: parseFloat(document.getElementById('adminTemperatureSlider').value),
            max_tokens: parseInt(document.getElementById('adminMaxTokensSlider').value),
            top_p: parseFloat(document.getElementById('adminTopPSlider').value),
            top_k: parseInt(document.getElementById('adminTopKSlider').value),
            repeat_penalty: parseFloat(document.getElementById('adminRepeatPenaltySlider').value)
        };
        
        fetch('/admin/save-default-parameters', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(parameters)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert(data.message);
            } else {
                alert('Error saving parameters: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving parameters');
        });
    }
    
    // Initialize admin parameter sliders
    function initializeAdminParameterSliders() {
        const sliders = [
            { id: 'adminTemperatureSlider', valueId: 'adminTemperatureValue' },
            { id: 'adminMaxTokensSlider', valueId: 'adminMaxTokensValue' },
            { id: 'adminTopPSlider', valueId: 'adminTopPValue' },
            { id: 'adminTopKSlider', valueId: 'adminTopKValue' },
            { id: 'adminRepeatPenaltySlider', valueId: 'adminRepeatPenaltyValue' }
        ];
        
        sliders.forEach(slider => {
            const element = document.getElementById(slider.id);
            const valueElement = document.getElementById(slider.valueId);
            
            if (element && valueElement) {
                element.addEventListener('input', function() {
                    valueElement.textContent = this.value;
                });
            }
        });
    }
    
    // Feedback management
    function showFeedbackDetails(id, title, description) {
        alert(`Feedback Details:\n\nTitle: ${title}\n\nDescription: ${description}`);
        // TODO: Replace with proper modal in future
    }
    
    // Socket.IO connection for real-time download progress
    const socket = io();
    
    socket.on('connect', function() {
        console.log('Socket.IO connected successfully');
    });
    
    socket.on('disconnect', function() {
        console.log('Socket.IO disconnected');
    });
    
    socket.on('download_progress', function(data) {
        console.log('Download progress received:', data);
        
        // Ensure progress section is visible
        const progressSection = document.getElementById('downloadProgressSection');
        if (progressSection) {
            progressSection.style.display = 'block';
        }
        
        if (data.status === 'starting') {
            updateDownloadStatus(data.message, data.progress);
        } else if (data.status === 'downloading') {
            let details = '';
            if (data.completed && data.total) {
                const completedMB = (data.completed / (1024 * 1024)).toFixed(1);
                const totalMB = (data.total / (1024 * 1024)).toFixed(1);
                details = `Downloaded: ${completedMB}MB / ${totalMB}MB`;
            }
            updateDownloadStatus(data.message, data.progress, details);
        } else if (data.status === 'completed') {
            updateDownloadStatus(data.message, 100);
            
            // Reset button and close modal after delay
            setTimeout(() => {
                const downloadBtn = document.querySelector('#downloadModal .btn-primary');
                resetDownloadButton(downloadBtn, '<i class="fas fa-download"></i> Download Model');
                bootstrap.Modal.getInstance(document.getElementById('downloadModal')).hide();
                refreshModels(); // Refresh the model list
            }, 2000);
        } else if (data.status === 'error') {
            updateDownloadStatus('Error: ' + data.message, 0);
            const downloadBtn = document.querySelector('#downloadModal .btn-primary');
            resetDownloadButton(downloadBtn, '<i class="fas fa-download"></i> Download Model');
        }
    });
    
    // Auto-check Ollama status on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkOllamaStatus();
        loadAvailableModels();
        initializeAdminParameterSliders();
    });
</script>
{% endblock %}
